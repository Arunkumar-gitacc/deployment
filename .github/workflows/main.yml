# name: Deploy to EC2

# on:
#   repository_dispatch:
#     types: [frontend_updated, backend_updated]

# permissions:
#   contents: write   # ‚úÖ THIS FIXES THE 403 ERROR

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Update env file
#         run: |
#           if [ "${{ github.event.action }}" = "frontend_updated" ]; then
#             sed -i "s/^FRONTEND_TAG=.*/FRONTEND_TAG=${{ github.event.client_payload.tag }}/" .env
#           fi

#           if [ "${{ github.event.action }}" = "backend_updated" ]; then
#             sed -i "s/^BACKEND_TAG=.*/BACKEND_TAG=${{ github.event.client_payload.tag }}/" .env
#           fi

#       - name: Commit updated version
#         run: |
#           git config user.name "ci-bot"
#           git config user.email "ci@github.com"
#           git add .env
#           git commit -m "Update image tag" || echo "No changes"
#           git push

#       - name: Deploy to EC2
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             cd /home/ec2-user/deployment
#             git pull origin main
#             docker compose pull
#             docker compose up -d --force-recreate --remove-orphans

# name: Deploy to EC2

# on:
#   repository_dispatch:
#     types: [frontend_updated, backend_updated]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Deploy on EC2
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ec2-user
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             set -e
#             cd /home/ec2-user/deployment

#             echo "üì• Sync deployment repo..."
#             git fetch origin
#             git reset --hard origin/main

#             EVENT_TYPE="${{ github.event.action }}"

#             echo "üîî Event type: $EVENT_TYPE"

#             if [ "$EVENT_TYPE" = "frontend_updated" ]; then
#               echo "üîñ Updating FRONTEND_TAG..."
#               sed -i "s/^FRONTEND_TAG=.*/FRONTEND_TAG=${{ github.event.client_payload.frontend_tag }}/" .env
#             fi

#             if [ "$EVENT_TYPE" = "backend_updated" ]; then
#               echo "üîñ Updating BACKEND_TAG..."
#               sed -i "s/^BACKEND_TAG=.*/BACKEND_TAG=${{ github.event.client_payload.backend_tag }}/" .env
#             fi

#             echo "üìÑ Current .env values:"
#             grep -E 'FRONTEND_TAG|BACKEND_TAG' .env

#             echo "üõë Stopping containers..."
#             docker compose down

#             echo "üì¶ Pulling images..."
#             docker compose pull

#             echo "‚ñ∂Ô∏è Starting containers..."
#             docker compose up -d --force-recreate --remove-orphans

#             echo "‚úÖ Deployment completed successfully"
# name: Branch-specific CI and CD

# on:
#   push:
#     branches:
#       - uat
#       - test
#       - demo

# jobs:
#   ci-cd:
#     runs-on: ubuntu-latest

#     steps:
#       # ---------------------------
#       # CHECKOUT CODE
#       # ---------------------------
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # ---------------------------
#       # SET BRANCH NAME
#       # ---------------------------
#       - name: Set branch name
#         run: |
#           echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV

#       # ---------------------------
#       # DETECT CHANGES
#       # ---------------------------
#       - name: Detect frontend & backend changes
#         run: |
#           FRONTEND_CHANGED=false
#           BACKEND_CHANGED=false

#           git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^frontend/' && FRONTEND_CHANGED=true || true
#           git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^backend/' && BACKEND_CHANGED=true || true

#           echo "FRONTEND_CHANGED=$FRONTEND_CHANGED" >> $GITHUB_ENV
#           echo "BACKEND_CHANGED=$BACKEND_CHANGED" >> $GITHUB_ENV

#           echo "Frontend changed: $FRONTEND_CHANGED"
#           echo "Backend changed: $BACKEND_CHANGED"

#       # ---------------------------
#       # DOCKER LOGIN
#       # ---------------------------
#       - name: Login to Docker registry
#         run: |
#           echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
#             -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

#       # ---------------------------
#       # BUILD & PUSH FRONTEND (CI)
#       # ---------------------------
#       - name: Build & push frontend image
#         if: env.FRONTEND_CHANGED == 'true'
#         run: |
#           docker build -t myorg/frontend:${BRANCH_NAME} ./frontend
#           docker push myorg/frontend:${BRANCH_NAME}

#       # ---------------------------
#       # BUILD & PUSH BACKEND (CI)
#       # ---------------------------
#       - name: Build & push backend image
#         if: env.BACKEND_CHANGED == 'true'
#         run: |
#           docker build -t myorg/backend:${BRANCH_NAME} ./backend
#           docker push myorg/backend:${BRANCH_NAME}

#       # ---------------------------
#       # DEPLOY TO EC2 (CD)
#       # ---------------------------
#       - name: Deploy application on EC2
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             set -e
#             echo "Deploying branch: ${BRANCH_NAME}"

#             cd /home/ec2-user/${BRANCH_NAME}

#             export BRANCH_NAME=${BRANCH_NAME}

#             docker compose pull
#             docker compose up -d
name: Branch Deploy to EC2 (CD only)

on:
  push:
    branches:
      - uat
      - test
      - demo

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------
      # SET BRANCH NAME
      # -----------------------
      - name: Set branch name
        run: |
          echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV

      # -----------------------
      # DEPLOY TO EC2
      # -----------------------
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ Deploying branch: ${BRANCH_NAME}"

            cd /home/ec2-user/${BRANCH_NAME}
            export BRANCH_NAME=${BRANCH_NAME}

            echo "üì¶ Pulling latest images for ${BRANCH_NAME}..."
            docker compose pull

            echo "‚ñ∂Ô∏è Restarting containers..."
            docker compose up -d --remove-orphans

            echo "‚úÖ Deployment completed for ${BRANCH_NAME}"
